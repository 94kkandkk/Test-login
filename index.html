<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bmob-æ— éªŒè¯æ³¨å†Œç™»å½•ï¼ˆå®˜æ–¹æ–‡æ¡£è§„èŒƒç‰ˆï¼‰</title>
    <style>
        * {margin: 0; padding: 0; box-sizing: border-box; font-family: "Microsoft YaHei", sans-serif;}
        body {padding: 20px; max-width: 420px; margin: 20px auto; background: #f5f5f5;}
        .container {background: #fff; padding: 30px; border-radius: 8px; box-shadow: 0 2px 12px rgba(0,0,0,0.08);}
        h3 {margin: 0 0 20px; color: #333; font-size: 18px; border-left: 4px solid #1890ff; padding-left: 10px;}
        .form-item {margin-bottom: 18px;}
        input {width: 100%; padding: 12px 15px; border: 1px solid #e5e5e5; border-radius: 6px; font-size: 16px; outline: none; transition: border-color 0.3s;}
        input:focus {border-color: #1890ff;}
        button {width: 100%; padding: 12px; background: #1890ff; color: #fff; border: none; border-radius: 6px; font-size: 16px; cursor: pointer; transition: background 0.3s; margin-bottom: 12px;}
        button:hover {background: #096dd9;}
        .tip {color: #666; font-size: 14px; line-height: 1.5; margin-top: 10px;}
    </style>
    <!-- è§£å†³favicon.ico 404ï¼ˆéå¿…éœ€ï¼Œä»…ç¾åŒ–ï¼‰ -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='90' font-size='90'>ğŸ‘¤</text></svg>">
</head>
<body>
<div class="container">
    <h3>ç”¨æˆ·æ³¨å†Œ & ç™»å½•ï¼ˆæ— æ‰‹æœº/é‚®ç®±éªŒè¯ï¼‰</h3>
    <div class="form-item">
        <input type="text" id="username" placeholder="è¯·è¾“å…¥ç”¨æˆ·åï¼ˆå”¯ä¸€ï¼‰" autocomplete="off">
    </div>
    <div class="form-item">
        <input type="password" id="pwd" placeholder="è¯·è¾“å…¥å¯†ç ï¼ˆè‡³å°‘6ä½ï¼‰" autocomplete="off">
    </div>
    <button onclick="registerAndAutoLogin()">æ³¨å†Œå¹¶è‡ªåŠ¨ç™»å½•</button>
    <button onclick="loginOnly()">å·²æœ‰è´¦å·ï¼Œç›´æ¥ç™»å½•</button>

    <h3>ç”¨æˆ·æ“ä½œ</h3>
    <button onclick="getUserInfo()">è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯</button>
    <button onclick="logout()">é€€å‡ºç™»å½•</button>

    <p class="tip">ä¸¥æ ¼éµå¾ªBmobå®˜æ–¹RESTfulæ–‡æ¡£ | ç”¨æˆ·åå”¯ä¸€ | æ³¨å†ŒæˆåŠŸè‡ªåŠ¨ç™»å½•</p>
</div>

<script>
    /************************* å·²é…ç½®ä½ çš„Bmobå¯†é’¥ï¼ˆæ— éœ€ä¿®æ”¹ï¼‰ *************************/
    const BMOB_APP_ID = "c141a3e46cf90c9c1a9911a145d649a2";
    const BMOB_REST_KEY = "43d61cb9d1472320be18437af499ee5c";
    /************************* å®˜æ–¹æ–‡æ¡£æŒ‡å®šçš„æ ¸å¿ƒé…ç½®ï¼ˆå›ºå®šä¸å˜ï¼‰ *************************/
    const BMOB_API_BASE = "https://api.bmob.cn/1"; // å®˜æ–¹ä¸»åŸŸåï¼ˆæ–‡æ¡£æŒ‡å®šï¼‰
    const BMOB_HEADERS = { // æ‰€æœ‰æ¥å£å¿…ä¼ å…¬å…±è¯·æ±‚å¤´ï¼ˆæ–‡æ¡£å¼ºåˆ¶è¦æ±‚ï¼‰
        "X-Bmob-Application-Id": BMOB_APP_ID,
        "X-Bmob-REST-API-Key": BMOB_REST_KEY,
        "Content-Type": "application/json",
        "X-Bmob-Client-Type": "Web" // æ ‡è¯†å®¢æˆ·ç«¯ç±»å‹ä¸ºWebï¼ˆæ–‡æ¡£æ¨èï¼‰
    };
    /************************* ç™»å½•çŠ¶æ€æŒä¹…åŒ– *************************/
    let userToken = localStorage.getItem('bmob_user_token') || ''; // ä¼šè¯ä»¤ç‰Œ

    /**
     * 1. æ³¨å†Œ+è‡ªåŠ¨ç™»å½•ï¼ˆæ— éªŒè¯ï¼Œç¬¦åˆå®˜æ–¹POST /usersæ¥å£è§„èŒƒï¼‰
     * æ–‡æ¡£å‚è€ƒï¼šhttps://doc.bmobapp.com/data/restful/develop_doc/#_46
     */
    async function registerAndAutoLogin() {
        const username = document.getElementById('username').value.trim();
        const password = document.getElementById('pwd').value.trim();

        // åŸºç¡€æ ¡éªŒï¼ˆä¸å®˜æ–¹æ¥å£æ ¡éªŒäº’è¡¥ï¼‰
        if (!username) {alert("è¯·è¾“å…¥ç”¨æˆ·åï¼"); return;}
        if (password.length < 6) {alert("å¯†ç è‡³å°‘6ä½ï¼"); return;}

        try {
            // æ­¥éª¤1ï¼šè°ƒç”¨å®˜æ–¹æ³¨å†Œæ¥å£ - POST /users
            const regRes = await fetch(`${BMOB_API_BASE}/users`, {
                method: "POST",
                headers: BMOB_HEADERS, // ç›´æ¥ä½¿ç”¨å®˜æ–¹å¿…ä¼ å…¬å…±å¤´
                body: JSON.stringify({ username, password }) // æ–‡æ¡£æŒ‡å®šå‚æ•°å­—æ®µ
            });
            const regResult = await regRes.json();

            // æ¥å£è¿”å›é200ï¼ŒæŒ‰å®˜æ–¹æ–‡æ¡£å¤„ç†é”™è¯¯ä¿¡æ¯
            if (!regRes.ok) {
                alert(`æ³¨å†Œå¤±è´¥ï¼š${regResult.error || regResult.code || "æœªçŸ¥é”™è¯¯"}`);
                return;
            }

            alert(`æ³¨å†ŒæˆåŠŸï¼ˆç”¨æˆ·IDï¼š${regResult.objectId}ï¼‰ï¼Œæ­£åœ¨è‡ªåŠ¨ç™»å½•...`);

            // æ­¥éª¤2ï¼šæ³¨å†ŒæˆåŠŸåï¼Œç«‹å³è°ƒç”¨å®˜æ–¹ç™»å½•æ¥å£ï¼Œå®ç°è‡ªåŠ¨ç™»å½•
            await loginOnly(); // å¤ç”¨ç‹¬ç«‹ç™»å½•é€»è¾‘ï¼Œå‡å°‘ä»£ç å†—ä½™
            // æ¸…ç©ºè¾“å…¥æ¡†
            document.getElementById('username').value = "";
            document.getElementById('pwd').value = "";

        } catch (error) {
            alert(`ç½‘ç»œ/æ¥å£å¼‚å¸¸ï¼š${error.message}\næ’æŸ¥å»ºè®®ï¼š1.æ£€æŸ¥ç½‘ç»œ 2.å…³é—­ä»£ç† 3.åˆ·æ–°DNS`);
            console.error("æ³¨å†Œè‡ªåŠ¨ç™»å½•å¼‚å¸¸ï¼š", error);
        }
    }

    /**
     * 2. ç‹¬ç«‹ç™»å½•ï¼ˆç¬¦åˆå®˜æ–¹GET /loginæ¥å£è§„èŒƒï¼‰
     * æ–‡æ¡£å‚è€ƒï¼šhttps://doc.bmobapp.com/data/restful/develop_doc/#_48
     */
    async function loginOnly() {
        const username = document.getElementById('username').value.trim();
        const password = document.getElementById('pwd').value.trim();

        if (!username || !password) {
            alert("è¯·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ï¼");
            return;
        }

        try {
            // æ‹¼æ¥å®˜æ–¹æ–‡æ¡£æŒ‡å®šçš„GETè¯·æ±‚å‚æ•°ï¼ŒencodeURIComponentå¤„ç†ç‰¹æ®Šå­—ç¬¦
            const loginParams = new URLSearchParams({
                username: encodeURIComponent(username),
                password: encodeURIComponent(password)
            });
            // è°ƒç”¨å®˜æ–¹ç™»å½•æ¥å£ - GET /login
            const loginRes = await fetch(`${BMOB_API_BASE}/login?${loginParams}`, {
                method: "GET",
                headers: BMOB_HEADERS // å…¬å…±è¯·æ±‚å¤´ï¼ˆæ–‡æ¡£è¦æ±‚ï¼‰
            });
            const loginResult = await loginRes.json();

            if (!loginRes.ok) {
                alert(`ç™»å½•å¤±è´¥ï¼š${loginResult.error || "ç”¨æˆ·å/å¯†ç é”™è¯¯"}`);
                return;
            }

            // æŒ‰å®˜æ–¹æ–‡æ¡£ï¼Œç™»å½•æˆåŠŸè¿”å›sessionTokenï¼ŒæŒä¹…åŒ–å­˜å‚¨
            userToken = loginResult.sessionToken;
            localStorage.setItem('bmob_user_token', userToken);
            alert(`ç™»å½•æˆåŠŸï¼æ¬¢è¿ä½ ï¼Œ${username}`);

        } catch (error) {
            alert(`ç½‘ç»œ/æ¥å£å¼‚å¸¸ï¼š${error.message}`);
            console.error("ç™»å½•å¼‚å¸¸ï¼š", error);
        }
    }

    /**
     * 3. è·å–ç”¨æˆ·ä¿¡æ¯ï¼ˆç¬¦åˆå®˜æ–¹GET /users/meæ¥å£è§„èŒƒï¼‰
     * æ–‡æ¡£å‚è€ƒï¼šhttps://doc.bmobapp.com/data/restful/develop_doc/#_50
     */
    async function getUserInfo() {
        // å…ˆæ ¡éªŒæœ¬åœ°ç™»å½•çŠ¶æ€
        if (!userToken) {
            alert("è¯·å…ˆç™»å½•ï¼");
            return;
        }

        try {
            // è°ƒç”¨å®˜æ–¹è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯æ¥å£ï¼Œéœ€æºå¸¦sessionTokené‰´æƒï¼ˆæ–‡æ¡£å¼ºåˆ¶è¦æ±‚ï¼‰
            const infoRes = await fetch(`${BMOB_API_BASE}/users/me`, {
                method: "GET",
                headers: {
                    ...BMOB_HEADERS, // ç»§æ‰¿å…¬å…±è¯·æ±‚å¤´
                    "X-Bmob-Session-Token": userToken // é‰´æƒä»¤ç‰Œï¼ˆæ–‡æ¡£æ ¸å¿ƒè¦æ±‚ï¼‰
                }
            });
            const infoResult = await infoRes.json();

            if (!infoRes.ok) {
                alert(`è·å–ä¿¡æ¯å¤±è´¥ï¼š${infoResult.error || "ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•"}`);
                // ä»¤ç‰Œå¤±æ•ˆï¼Œæ¸…é™¤æœ¬åœ°çŠ¶æ€
                localStorage.removeItem('bmob_user_token');
                userToken = '';
                return;
            }

            // æŒ‰å®˜æ–¹è¿”å›å­—æ®µï¼Œæ‹¼æ¥ç”¨æˆ·ä¿¡æ¯
            const userInfo = `
å½“å‰ç™»å½•ç”¨æˆ·ä¿¡æ¯ï¼ˆå®˜æ–¹æ¥å£è¿”å›ï¼‰ï¼š
â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
ç”¨æˆ·IDï¼š${infoResult.objectId}
ç”¨æˆ·åï¼š${infoResult.username}
æ³¨å†Œæ—¶é—´ï¼š${new Date(infoResult.createdAt).toLocaleString()}
æœ€åæ›´æ–°ï¼š${new Date(infoResult.updatedAt).toLocaleString()}
            `;
            alert(userInfo);

        } catch (error) {
            alert(`ç½‘ç»œ/æ¥å£å¼‚å¸¸ï¼š${error.message}`);
            console.error("è·å–ç”¨æˆ·ä¿¡æ¯å¼‚å¸¸ï¼š", error);
        }
    }

    /**
     * 4. é€€å‡ºç™»å½•ï¼ˆç¬¦åˆå®˜æ–¹POST /logoutæ¥å£è§„èŒƒï¼‰
     * æ–‡æ¡£å‚è€ƒï¼šhttps://doc.bmobapp.com/data/restful/develop_doc/#_49
     */
    async function logout() {
        if (!userToken) {
            alert("ä½ è¿˜æœªç™»å½•ï¼");
            return;
        }

        try {
            // è°ƒç”¨å®˜æ–¹é€€å‡ºç™»å½•æ¥å£ï¼Œéœ€æºå¸¦sessionToken
            await fetch(`${BMOB_API_BASE}/logout`, {
                method: "POST",
                headers: {
                    ...BMOB_HEADERS,
                    "X-Bmob-Session-Token": userToken
                }
            });
        } catch (error) {
            console.error("é€€å‡ºæ¥å£å¼‚å¸¸ï¼ˆå·²å¼ºåˆ¶æ¸…é™¤æœ¬åœ°çŠ¶æ€ï¼‰ï¼š", error);
        } finally {
            // æ— è®ºæ¥å£æ˜¯å¦æˆåŠŸï¼Œå¼ºåˆ¶æ¸…é™¤æœ¬åœ°ä»¤ç‰Œï¼ˆå®˜æ–¹æ¨èï¼‰
            localStorage.removeItem('bmob_user_token');
            userToken = '';
            // æ¸…ç©ºè¾“å…¥æ¡†
            document.getElementById('username').value = "";
            document.getElementById('pwd').value = "";
            alert("é€€å‡ºç™»å½•æˆåŠŸï¼");
        }
    }
</script>
</body>
</html>
